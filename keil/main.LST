C51 COMPILER V8.02   MAIN                                                                  05/27/2013 12:42:00 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: e:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*
   2                  单向异步电机pwm调速 
   3                  mcu：stc89c52
   4                  电脑控制
   5          */
   6          #include<reg51.h>
   7          #include "modbus_slave.h"
   8          #include"uart.h"
   9          #include "soft_timer.h"
  10          
  11          #define ON 0
  12          #define OFF 1
  13          
  14          
  15          sbit FZ = P2^7;
  16          sbit ZZ = P2^4; 
  17          
  18          static unsigned char started_flg = 0;
  19          
  20          static unsigned char step = 1;                                   
  21                                                                  
  22          unsigned char time_getter[4];//电机运行时间数组 0--正转时间 1 停止时间1  2反转时间 3停止时间2
  23          
  24          void init_timer0(void);
  25          
  26          void run_motor(void);
  27          
  28          void main(void)
  29          {
  30   1              FZ = OFF;
  31   1              ZZ = OFF;
  32   1      
  33   1      
  34   1              //电机运行时间初始值
  35   1              time_getter[0] = 45;//正转
  36   1      
  37   1              time_getter[1] = 1; //停止时间1
  38   1      
  39   1              time_getter[2] = 4; //反转
  40   1      
  41   1              time_getter[3] = 65;//停止时间2
  42   1      
  43   1              init_uart();
  44   1      
  45   1              init_timer0();
  46   1      
  47   1      
  48   1               modbus_reg[0] = 45;
  49   1               modbus_reg[1] = 1;
  50   1               modbus_reg[2]  = 4;
  51   1               modbus_reg[3] = 65;
  52   1      
  53   1               modbus_reg[4]  = 1;//启动
  54   1      
  55   1               modbus_reg[5]  = 1;//动作状态步
C51 COMPILER V8.02   MAIN                                                                  05/27/2013 12:42:00 PAGE 2   

  56   1      
  57   1               modbus_reg[6] = 1;//电机运行标志
  58   1      
  59   1               modbus_reg[7] = 0;//循环次数
  60   1      
  61   1      
  62   1              EA = 1;
  63   1              
  64   1              while(1)
  65   1              {
  66   2                      if( modbus_reg[4]==1)
  67   2                      {
  68   3                              run_motor();
  69   3                              modbus_reg[5] = step;   
  70   3                      }
  71   2                      else
  72   2                      {
  73   3                              //停止的时候可以设置时间
  74   3                              time_getter[0] = modbus_reg[0];
  75   3                              time_getter[1] = modbus_reg[1];
  76   3                              time_getter[2] = modbus_reg[2];
  77   3                              time_getter[3] = modbus_reg[3];
  78   3                              modbus_reg[5] = 0;//动作状态步
  79   3                              FZ  = 1;
  80   3                              ZZ = 1;
  81   3                              started_flg = 0;
  82   3                              step = 1;
  83   3                              //modbus_reg[7] = 0;
  84   3                      }
  85   2      
  86   2                      modbus_decode(); 
  87   2              }
  88   1      }       
  89          void init_timer0(void)
  90          {
  91   1              TMOD |=0x01 ;//定时器0工作在方式一
  92   1              TH0 = 0xdc;//11.0592
  93   1              TL0 = 0x00;
  94   1      
  95   1              ET0 = 1;  //使能定时器0中断
  96   1              TR0 =1;  //启动定时器0
  97   1      
  98   1      }
  99          
 100          void timer0_isr(void) interrupt 1
 101          {
 102   1      
 103   1              TH0 = 0xdc;//11.0592
 104   1              TL0 = 0x00;
 105   1      
 106   1              update_all_timers();
 107   1      
 108   1      }
 109          
 110          void run_motor(void)
 111          {
 112   1      
 113   1      
 114   1              switch(step)
 115   1              {
 116   2                      case 1:
 117   2                      modbus_reg[6] = 1;      
C51 COMPILER V8.02   MAIN                                                                  05/27/2013 12:42:00 PAGE 3   

 118   2                      
 119   2                      if(started_flg==0)
 120   2                      {
 121   3                              start_soft_timer(SOFT_TIMER0,time_getter[0]*100);
 122   3                              ZZ = 0;//电机正转
 123   3                              started_flg = 1;                         
 124   3                      }
 125   2                      else
 126   2                      {
 127   3                              if(check_soft_timer(SOFT_TIMER0))
 128   3                              {
 129   4                                      step = 2;
 130   4                                      started_flg = 0;                
 131   4                              }       
 132   3                      }
 133   2                      break;
 134   2                      case 2:
 135   2                      modbus_reg[6] = 0;      
 136   2                      if(started_flg==0)
 137   2                      {
 138   3                              start_soft_timer(SOFT_TIMER0,time_getter[1]*100);
 139   3                              ZZ = 1;//电机停止时间1
 140   3                              started_flg = 1;        
 141   3                      }
 142   2                      else
 143   2              
 144   2                      {
 145   3                              if(check_soft_timer(SOFT_TIMER0))
 146   3                              {
 147   4                                      step = 3;
 148   4                                      started_flg = 0;                
 149   4                              }       
 150   3                      }
 151   2                      break;
 152   2                      case 3:
 153   2                      modbus_reg[6] = 1;      
 154   2                      if(started_flg==0)
 155   2                      {
 156   3                              start_soft_timer(SOFT_TIMER0,time_getter[2]*100);
 157   3                              FZ = 0;//电机反转
 158   3                              started_flg = 1;        
 159   3                      }
 160   2                      else
 161   2                      {
 162   3                              if(check_soft_timer(SOFT_TIMER0))
 163   3                              {
 164   4                                      step = 4;
 165   4                                      started_flg = 0;                
 166   4                              }       
 167   3                      }
 168   2                      break;
 169   2                      case 4:
 170   2                      modbus_reg[6] = 0;      
 171   2                      if(started_flg==0)
 172   2                      {
 173   3                              start_soft_timer(SOFT_TIMER0,time_getter[3]*100);
 174   3                              FZ = 1;//电机停止时间2
 175   3                              started_flg = 1;        
 176   3                      }
 177   2                      else
 178   2                      {
 179   3                              if(check_soft_timer(SOFT_TIMER0))
C51 COMPILER V8.02   MAIN                                                                  05/27/2013 12:42:00 PAGE 4   

 180   3                              {
 181   4                                      step = 1;
 182   4                                      started_flg = 0;        
 183   4                                      modbus_reg[7]++;        
 184   4                              }       
 185   3                      }
 186   2                      break;
 187   2                      default:
 188   2                              step = 1;
 189   2                              started_flg = 0;
 190   2                      break;  
 191   2              }
 192   1      }
 193          
 194          
 195          
 196          
 197          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    407    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
